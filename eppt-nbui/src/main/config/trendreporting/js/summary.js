/*
 * Enhanced Post Processing Tool (EPPT) Copyright (c) 2019.
 *
 * EPPT is copyrighted by the State of California, Department of Water Resources. It is licensed
 * under the GNU General Public License, version 2. This means it can be
 * copied, distributed, and modified freely, but you may not restrict others
 * in their ability to copy, distribute, and modify it. See the license below
 * for more details.
 *
 * GNU General Public License
 */


// plot({"period_months":["Nov"],"scenario_run_data":[{"statistically_computed_time_series_yearly":1479.7776219317077,"scenario_name":"DCR19_CSII","period_filtered_time_series":[[1945,1153.0159759380379],[1946,1314.9305248783112],[1947,1136.4858155518089],[1948,1406.631211621606],[1949,1328.0556908537337],[1950,1427.2354105597726],[1951,1552.4095962954186],[1952,1845.3146506149888],[1953,1850],[1954,1783.6973430033988]],"statistically_computed_time_series_monthly":[["Nov",1479.7776219317077]],"statistically_computed_time_series_wyt":[{"water_year_period":"Wet","water_year_period_values":1847.6573253074944},{"water_year_period":"Above Normal","water_year_period_values":1668.0534696494087},{"water_year_period":"Below Normal","water_year_period_values":1325.453280749432},{"water_year_period":"Dry","water_year_period_values":1232.2707532027712},{"water_year_period":"Critical"}],"scenario_color":"#4C7EEEFF","full_time_series":[[-762624000000,1097.9962460469092],[-760032000000,1153.0159759380379],[-757353600000,1344.2571831026626],[-754675200000,1474.7749835865113],[-752256000000,1529.8045334639633],[-749577600000,1652.1236160210108],[-746985600000,1870.3318696245055],[-744307200000,1865.8511104822965],[-741715200000,1771.5684324196786],[-739036800000,1640.496858873542],[-736358400000,1494.7886843557626],[-733766400000,1381.882472868788],[-731088000000,1321.293169270252],[-728496000000,1314.9305248783112],[-725817600000,1326.648604085127],[-723139200000,1325.7667851865149],[-720720000000,1385.7937518289755],[-718041600000,1504.9161062294547],[-715449600000,1592.347131235816],[-712771200000,1500.741243154789],[-710179200000,1485.9530070256653],[-707500800000,1360.9121255837874],[-704822400000,1196.9745556724433],[-702230400000,1112.5929370860956],[-699552000000,1125.5418620848372],[-696960000000,1136.4858155518089],[-694281600000,1135.8422797290796],[-691603200000,1328.414419444375],[-689097600000,1350.9090907689601],[-686419200000,1376.1748579496568],[-683827200000,1548.51417723876],[-681148800000,1542.9303442375374],[-678556800000,1622.6620969179107],[-675878400000,1587.0997168312638],[-673200000000,1475.4795914576762],[-670608000000,1453.5486483667592],[-667929600000,1399.728456425258],[-665337600000,1406.631211621606],[-662659200000,1408.6819093156766],[-659980800000,1402.1010021474556],[-657561600000,1433.9921390754926],[-654883200000,1650.2094172520656],[-652291200000,1909.9749514302737],[-649612800000,1910.9795701553644],[-647020800000,1860.3797801059789],[-644342400000,1715.3802862073003],[-641664000000,1567.2750969786277],[-639072000000,1423.292866606472],[-636393600000,1361.0399483512494],[-633801600000,1328.0556908537337],[-631123200000,1309.1568233596943],[-628444800000,1327.2877192474075],[-626025600000,1375.1697139635212],[-623347200000,1496.2401103199325],[-620755200000,1650.356235345985],[-618076800000,1654.2572199129254],[-615484800000,1635.8077527434339],[-612806400000,1497.9140266458487],[-610128000000,1362.820808229756],[-607536000000,1249.7203128839894],[-604857600000,1311.5381334442113],[-602265600000,1427.2354105597726],[-599587200000,1684.8640014887794],[-596908800000,1774.845373631593],[-594489600000,1992.6160871988914],[-591811200000,2093.671873274067],[-589219200000,2224.8362140061618],[-586540800000,2156.8636833287082],[-583948800000,2072.7615491870893],[-581270400000,1925.3479202204412],[-578592000000,1776.08571304093],[-576000000000,1631.5634832408011],[-573321600000,1547.2433813373905],[-570729600000,1552.4095962954186],[-568051200000,1699.80995483482],[-565372800000,1759.2101931267339],[-562867200000,1949.218148402314],[-560188800000,2100],[-557596800000,2300],[-554918400000,2410.9636868144175],[-552326400000,2447],[-549648000000,2269.9999999999995],[-546969600000,2150],[-544377600000,1974.9999999999998],[-541699200000,1850],[-539107200000,1845.3146506149888],[-536428800000,1850],[-533750400000,1900],[-531331200000,2000],[-528652800000,2100],[-526060800000,2261.7226663483316],[-523382400000,2221.7112482758],[-520790400000,2315.3502604672717],[-518112000000,2270],[-515433600000,2149.9999999999995],[-512841600000,1968.0852911345996],[-510163200000,1850],[-507571200000,1850],[-504892800000,1850],[-502214400000,1900.0000000000002],[-499795200000,2000],[-497116800000,2100],[-494524800000,2300],[-491846400000,2271.5030161556515],[-489254400000,2203.9284707404],[-486576000000,2067.0659267830147],[-483897600000,1957.2604071701448],[-481305600000,1820.1402926548585],[-478627200000,1762.8480945854792],[-476035200000,1783.6973430033988],[-473356800000,1824.7603264444317],[-470678400000,1843.0369967483314],[-468259200000,1871.8530464096796],[-465580800000,1901.8631615797367],[-462988800000,1947.8153564834001],[-460310400000,1946.0188434340612],[-457718400000,1930.9501258609125],[-455040000000,1711.302575791276],[-452361600000,1560.1705810672827],[-449769600000,1416.2115991826997]]},{"statistically_computed_time_series_yearly":1471.9379581061016,"scenario_name":"DCR_2017Base","period_filtered_time_series":[[1945,1181.201221042839],[1946,1354.5292293570542],[1947,1167.2277871658434],[1948,1420.4465212895252],[1949,1301.6614240185622],[1950,1462.3849357597492],[1951,1518.7352008707492],[1952,1837.304443957726],[1953,1850],[1954,1625.8888175989669]],"statistically_computed_time_series_monthly":[["Nov",1471.9379581061016]],"statistically_computed_time_series_wyt":[{"water_year_period":"Wet","water_year_period_values":1843.652221978863},{"water_year_period":"Above Normal","water_year_period_values":1572.3120092348581},{"water_year_period":"Below Normal","water_year_period_values":1354.640476862292},{"water_year_period":"Dry","water_year_period_values":1234.4446055922028},{"water_year_period":"Critical"}],"scenario_color":"#FF66CCFF","full_time_series":[[-762624000000,1126.1933408189113],[-760032000000,1181.201221042839],[-757353600000,1372.4366128044212],[-754675200000,1502.949288575004],[-752256000000,1557.972896061891],[-749577600000,1680.2704141524907],[-746985600000,1907.3594702973778],[-744307200000,1893.8922090659055],[-741715200000,1836.9317784118232],[-739036800000,1696.7354424557218],[-736358400000,1525.0337997732597],[-733766400000,1398.9587188737778],[-731088000000,1346.027927217081],[-728496000000,1354.5292293570542],[-725817600000,1375.4634256056552],[-723139200000,1376.8429033994992],[-720720000000,1434.5838170478505],[-718041600000,1553.6508565902498],[-715449600000,1649.888947467191],[-712771200000,1558.4280811797428],[-710179200000,1543.3355433569664],[-707500800000,1433.3591600074637],[-704822400000,1261.7527289235825],[-702230400000,1137.3367003173366],[-699552000000,1153.3203997498251],[-696960000000,1167.2277871658434],[-694281600000,1170.9467185749459],[-691603200000,1365.2910398607214],[-689097600000,1384.7025802862943],[-686419200000,1419.1697112674615],[-683827200000,1606.3120676206086],[-681148800000,1600.5645997664926],[-678556800000,1680.0860411075525],[-675878400000,1646.0728363597302],[-673200000000,1506.6826031140574],[-670608000000,1462.1971093874145],[-667929600000,1428.39663047852],[-665337600000,1420.4465212895252],[-662659200000,1428.643683527664],[-659980800000,1417.3306397354943],[-657561600000,1447.800974334735],[-654883200000,1664.006735569298],[-652291200000,1923.7518169954901],[-649612800000,1924.7214111109722],[-647020800000,1882.989082679996],[-644342400000,1729.026919860797],[-641664000000,1555.0859869227925],[-639072000000,1386.1792848266753],[-636393600000,1331.6579807257765],[-633801600000,1301.6614240185622],[-631123200000,1285.8405679478346],[-628444800000,1307.0487728709325],[-626025600000,1363.2675570827016],[-623347200000,1484.3459846847811],[-620755200000,1647.4042921912446],[-618076800000,1655.5412608095937],[-615484800000,1633.4041775166452],[-612806400000,1526.201104485288],[-610128000000,1403.550968267341],[-607536000000,1277.2498036756738],[-604857600000,1385.1045910167434],[-602265600000,1462.3849357597492],[-599587200000,1720.0054542091032],[-596908800000,1809.9816872904387],[-594489600000,2000],[-591811200000,2100],[-589219200000,2294.5403188062296],[-586540800000,2217.5091071736506],[-583948800000,2136.6356476479764],[-581270400000,1985.623239597306],[-578592000000,1764.3155817750212],[-576000000000,1594.8513736444622],[-573321600000,1510.5784833488794],[-570729600000,1518.7352008707492],[-568051200000,1666.1410492783],[-565372800000,1725.5456059183966],[-562867200000,1915.5637852595908],[-560188800000,2081.5235453921127],[-557596800000,2300],[-554918400000,2410.963686814417],[-552326400000,2447],[-549648000000,2270],[-546969600000,2150],[-544377600000,1975],[-541699200000,1842.0680569381677],[-539107200000,1837.304443957726],[-536428800000,1850],[-533750400000,1900],[-531331200000,2000],[-528652800000,2100],[-526060800000,2300],[-523382400000,2259.9112123923715],[-520790400000,2353.448239660465],[-518112000000,2270],[-515433600000,2150],[-512841600000,1975],[-510163200000,1850],[-507571200000,1850],[-504892800000,1850],[-502214400000,1900],[-499795200000,2000],[-497116800000,2100],[-494524800000,2300],[-491846400000,2271.5030161556515],[-489254400000,2206.45991483751],[-486576000000,2067.0659267830138],[-483897600000,1854.7149140411382],[-481305600000,1692.863816871314],[-478627200000,1604.991412297459],[-476035200000,1625.8888175989669],[-473356800000,1666.9705269470674],[-470678400000,1685.2655131310007],[-468259200000,1714.1247468263027],[-465580800000,1753.481976837696],[-462988800000,1799.3251872384258],[-460310400000,1804.3706726705823],[-457718400000,1789.7390174390785],[-455040000000,1650.4038854457485],[-452361600000,1473.7083920843418],[-449769600000,1346.6476088255822]]},{"statistically_computed_time_series_yearly":1476.8598009125824,"scenario_name":"Sample","period_filtered_time_series":[[1945,1153.3270271022875],[1946,1315.235348664274],[1947,1136.7828943982088],[1948,1406.9217732133252],[1949,1328.3403320314358],[1950,1427.513608119192],[1951,1552.1817576429144],[1952,1845.314650614989],[1953,1850.0000000000002],[1954,1752.9806173391985]],"statistically_computed_time_series_monthly":[["Nov",1476.8598009125824]],"statistically_computed_time_series_wyt":[{"water_year_period":"Wet","water_year_period_values":1847.6573253074946},{"water_year_period":"Above Normal","water_year_period_values":1652.5811874910564},{"water_year_period":"Below Normal","water_year_period_values":1325.7494392747697},{"water_year_period":"Dry","water_year_period_values":1232.5616132148223},{"water_year_period":"Critical"}],"scenario_color":"#2DDE88FF","full_time_series":[[-762624000000,1098.307427921103],[-760032000000,1153.3270271022875],[-757353600000,1344.5681700883722],[-754675200000,1475.08591636622],[-752256000000,1530.1154006632075],[-749577600000,1652.4342456252425],[-746985600000,1870.6420846264011],[-744307200000,1866.1605748974935],[-741715200000,1771.8769663611308],[-739036800000,1640.804231062008],[-736358400000,1495.0949190940444],[-733766400000,1382.18781174728],[-731088000000,1321.598107654297],[-728496000000,1315.235348664274],[-725817600000,1326.9533795055254],[-723139200000,1326.071522023818],[-720720000000,1386.0983741285527],[-718041600000,1505.220383168984],[-715449600000,1592.6507043988906],[-712771200000,1501.0437086952402],[-710179200000,1486.2542825359264],[-707500800000,1361.2120090353114],[-704822400000,1197.2732102505433],[-702230400000,1112.8905826864425],[-699552000000,1125.839060069024],[-696960000000,1136.7828943982088],[-694281600000,1136.1393064733618],[-691603200000,1328.7113695844953],[-689097600000,1351.205960848765],[-686419200000,1376.4715596961962],[-683827200000,1548.8104495423859],[-681148800000,1543.2257590641454],[-678556800000,1622.9564338645184],[-675878400000,1587.3929270314316],[-673200000000,1475.7715264652725],[-670608000000,1453.8397457208137],[-667929600000,1400.019133810683],[-665337600000,1406.9217732133252],[-662659200000,1408.9724314118646],[-659980800000,1402.391499731875],[-657561600000,1434.2825644983861],[-654883200000,1650.499600452303],[-652291200000,1910.2647053003618],[-649612800000,1911.2685874000476],[-647020800000,1860.6678677979753],[-644342400000,1715.667300973793],[-641664000000,1567.561190831241],[-639072000000,1423.5780259464482],[-636393600000,1361.3247163114534],[-633801600000,1328.3403320314358],[-631123200000,1309.4414228934518],[-628444800000,1327.572280359362],[-626025600000,1375.4541637003997],[-623347200000,1496.5243681180104],[-620755200000,1650.6398596006181],[-618076800000,1654.5401218442587],[-615484800000,1636.0897808651052],[-612806400000,1498.1948614679172],[-610128000000,1363.1004057223445],[-607536000000,1249.999080680636],[-604857600000,1311.8164632816477],[-602265600000,1427.513608119192],[-599587200000,1685.142135157033],[-596908800000,1775.1234666257733],[-594489600000,1992.8940978202213],[-591811200000,2093.9496681949954],[-589219200000,2224.604681667414],[-586540800000,2156.632682132626],[-583948800000,2072.531183907833],[-581270400000,1925.1183440300392],[-578592000000,1775.8569440957924],[-576000000000,1631.3352618272258],[-573321600000,1547.0154436823602],[-570729600000,1552.1817576429144],[-568051200000,1699.5821527908242],[-565372800000,1758.9824209797937],[-562867200000,1948.9904454306575],[-560188800000,2100],[-557596800000,2299.9999999999995],[-554918400000,2410.963686814417],[-552326400000,2447],[-549648000000,2270],[-546969600000,2150],[-544377600000,1975],[-541699200000,1850],[-539107200000,1845.314650614989],[-536428800000,1850.0000000000002],[-533750400000,1900],[-531331200000,2000],[-528652800000,2100],[-526060800000,2261.5523187909903],[-523382400000,2221.541245040021],[-520790400000,2315.180711100164],[-518112000000,2270],[-515433600000,2150],[-512841600000,1968.2064945965153],[-510163200000,1850],[-507571200000,1850.0000000000002],[-504892800000,1850],[-502214400000,1900.0000000000002],[-499795200000,2000],[-497116800000,2100],[-494524800000,2300],[-491846400000,2271.5030161556515],[-489254400000,2203.9284707404],[-486576000000,2067.065926783014],[-483897600000,1957.2604071701442],[-481305600000,1820.140292654858],[-478627200000,1732.1219220757666],[-476035200000,1752.9806173391985],[-473356800000,1794.047286566081],[-470678400000,1812.3275270533768],[-468259200000,1841.1519822817618],[-465580800000,1871.1869552473431],[-462988800000,1917.1761693201586],[-460310400000,1915.4595638042326],[-457718400000,1900.4854384173277],[-455040000000,1680.9562557404156],[-452361600000,1529.9303154244933],[-449769600000,1415.7787116432064]]}],"gui_link_title":"Trinity Reservoir Storage","taf":false,"units":"STORAGE (TAF)","month_period_title":"November","statistics":"Averages"});

function getSeries(datum) {
    var seriesData = new Array(datum.length);
    for (var i = 0; i < datum.length; i++) {
        var average = calcScenarioValue(datum[i]);
        seriesData[i] = {
            name: datum[i]['scenario_name'],
            y: average,
            scenario_color: datum[i]['scenario_color']
        };
    }
    return seriesData;
}

function calcScenarioValue(datum) {
    return datum['statistically_computed_time_series_yearly'];
}

function plot(data) {
    let plotlyData = getPlotlySeries(data['scenario_run_data']);
    buildChart(data, plotlyData);
    buildPlotlyTable(data);
}

function getPlotlySeries(datum) {
    let x = [];
    let y = [];
    let color = [];
    for (var i = 0; i < datum.length; i++) {
        y.push(calcScenarioValue(datum[i]));
        x.push(datum[i]['scenario_name']);
        color.push(datum[i]['scenario_color']);
    }
    return {
        x: x,
        y: y,
        type: 'bar',
        textposition: 'auto',
        marker: {
            color: color
        }
    };
}

function buildChart(data, plotlyData) {
    let min = Math.min.apply(null, plotlyData['y']);
    let max = Math.max.apply(null, plotlyData['y']);
    var yrange = [min - min*0.05,  max + max*0.05];
    var layout = {
        font: PLOTLY_FONT,
        yaxis: {
            title: {
                text: data['units'],
            },
            range: yrange,
            gridcolor: '#CCCCCC'
        },
        legend: {
            orientation: 'h',
            xanchor: 'center',
            x: 0.5,
            font: {
                size: 10,
            }
        },
        title: {
            text: data['gui_link_title'] + '<br>' + data['month_period_title'] + '<br>' + data['statistics'],
            font: {
                family:PLOTLY_FONT['family'],
                size: 20,
            }
        }
    };

    Plotly.newPlot('tester', [plotlyData], layout, {
        displaylogo: false,
        modeBarButtonsToRemove: ['toImage', 'sendDataToCloud', 'editInChartStudio', 'lasso2d', 'select2d', 'resetScale2d'],
        scrollZoom: true,
        responsive: true
    });
    $("#tester").mousedown((ev) => {
        if (ev.which === 3) {
            openContextMenu('#tester', ev, plotlyCopyToClipboard, plotlyExportFunction(document.getElementById("tester")));
        }
    });
}

function buildPlotlyTable(data) {
    var layout = {
        font: PLOTLY_FONT,
        title: {
            text: data['gui_link_title'] + '<br>' + data['month_period_title'] + '<br>' + data['statistics'],
        }
    };
    var header = [['Scenario'], [data['units']]];
    var scenarios = [];
    var volumes = [];
    var colors = [];
    var headerColors = [];
    for (var i = 0; i < data['scenario_run_data'].length; i++) {
        let scenarioName = data['scenario_run_data'][i]['scenario_name'];
        scenarios.push(scenarioName);
        headerColors.push(data['scenario_run_data'][i]['scenario_color']);
        volumes.push(Math.round(calcScenarioValue(data['scenario_run_data'][i])));
        if (i < data['scenario_run_data'].length - 1) {
            header.push(['Difference from<br>' + scenarioName]);
        }
    }
    colors.push(headerColors);
    var values = [scenarios, volumes];
    for (var i = 1; i < volumes.length; i++) {
        var diffValues = [];
        for (var j = 0; j < data['scenario_run_data'].length; j++) {
            if (j < i) {
                diffValues.push('');
            } else {
                var diff = calcScenarioValue(data['scenario_run_data'][j]) - calcScenarioValue(data['scenario_run_data'][i - 1]);
                diffValues.push(Math.round(diff));
            }
        }
        values.push(diffValues);
    }
    var tableData = [{
        type: 'table',
        header: {
            values: header,
            align: "center",
            line: {width: 1, color: 'black'},
            font: {family: PLOTLY_FONT['family'], size: 11}
        },
        cells: {
            values: values,
            align: ['left', 'center'],
            height: 30,
            line: {color: "black", width: 1},
            font: {family: PLOTLY_FONT['family'], color: colors, size: [11, 13]}
        }
    }];

    Plotly.newPlot('table', tableData, layout, {
        displaylogo: false,
        displayModeBar: false,
        scrollZoom: true,
        responsive: true,
        staticPlot: true
    });
    $("#table").mousedown((ev) => {
        if (ev.which === 3) {
            openContextMenu('#table', ev, plotlyCopyTableClipboard, plotlyExportFunction(document.getElementById("table")));
        }
    });
}

function plotlyCopyTableClipboard() {
    let plot = document.getElementById("table");
    let layout = plot.layout;
    let data = plot.data[0];
    var text = layout['title']['text'].replace(/<br>/g, ' ') + '\n';
    for (var i = 0; i < data['header']['values'].length; i++) {
        let header = data['header']['values'][i][0].replace(/<br>/g, ' ');
        text += header + '\t';
    }
    text += '\n';
    let values = data['cells']['values'];
    var rows = values[0].length;
    for (var j = 0; j < rows; j++) {
        for (var k = 0; k < values.length; k++) {
            text += values[k][j] + '\t';
        }
        text += '\n';
    }
    copyTextToClipboard(text);
}

function plotlyCopyToClipboard() {
    let plot = document.getElementById("tester");
    let layout = plot.layout;
    let data1 = plot.data;
    var text = layout['title']['text'] + '\n' + 'Scenario\t' + layout['yaxis']['title']['text'] + '\n';
    for (var i = 0; i < data1.length; i++) {
        let datum = data1[i];
        let xarr = datum['x'];
        let yarr = datum['y'];
        for (var j = 0; j < xarr.length && j < yarr.length; j++) {
            text += xarr[j] + '\t' + yarr[j] + '\n';
        }
    }
    copyTextToClipboard(text);
}
